<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å¸–å­è¯¦æƒ…</title>
    <link rel="stylesheet" href="/common.css" />
    <style>
        body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#f5f6f8; }
        .detail-shell { max-width:960px; margin:0 auto; padding:24px 16px 40px; }
        .detail-topbar { display:flex; justify-content:flex-start; margin-bottom:18px; }
        .back-btn { border:none; background:#2b7cff; color:#fff; padding:8px 18px; border-radius:6px; cursor:pointer; font-size:15px; }
        .gallery-container { width:100%; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 4px 18px rgba(0,0,0,0.06); margin-bottom:20px; }
        .carousel { position:relative; width:100%; overflow:hidden; touch-action:pan-y; }
        .carousel-track { display:flex; transition:transform 320ms ease; will-change:transform; }
        .carousel-item {
            flex:0 0 auto;
            display:flex;
            justify-content:center;
            align-items:center;
            padding:18px;
            background:#111;
            width:100%;
            box-sizing:border-box;
        }
        .carousel-item img { max-width:100%; max-height:70vh; object-fit:contain; border-radius:6px; box-shadow:0 8px 20px rgba(0,0,0,0.35); user-select:none; }
        .carousel-indicators { display:flex; justify-content:center; gap:8px; padding:12px 0; background:#fff; }
        .carousel-indicator { width:8px; height:8px; border-radius:50%; background:#c8cbd4; cursor:pointer; transition:background 160ms ease; }
        .carousel-indicator.active { background:#2b7cff; }
        .article-card { background:#fff; border-radius:10px; padding:20px 22px; box-shadow:0 4px 18px rgba(0,0,0,0.05); }
        .article-title { font-size:1.8rem; color:#1c1d21; margin:0 0 12px; line-height:1.35; }
        .article-meta { color:#6b7280; font-size:14px; margin-bottom:18px; display:flex; gap:12px; flex-wrap:wrap; }
        .article-content { white-space:pre-wrap; line-height:1.8; color:#2f3137; font-size:16px; }
        @media (max-width:768px) {
            .detail-shell { padding:16px 12px 32px; }
            .article-card { padding:16px; }
            .article-title { font-size:1.4rem; }
        }
        .detail-shell {
            max-width:960px;
            margin:0 auto;
            padding:24px 16px 40px;
            display:flex;
            flex-direction:column;
            gap:20px;
        }
        .gallery-container,
        .article-card {
            width:100%;
        }
        #comments-section { width: 100%; padding: 0 16px; box-sizing: border-box; }
        #comments-section .article-card { width: 100%; }
    </style>
</head>
<body>
<div id="header-container"></div>
<main class="detail-shell">
    <div class="detail-topbar">
        <button class="back-btn" id="back-btn">è¿”å›</button>
    </div>
    <div class="gallery-container" id="gallery-container" style="display:none;">
        <div class="carousel" id="carousel">
            <div class="carousel-track" id="carousel-track"></div>
        </div>
        <div class="carousel-indicators" id="carousel-indicators"></div>
    </div>
    <article class="article-card">
        <h1 class="article-title" id="article-title"></h1>
        <div class="article-meta" id="article-meta"></div>
        <div class="article-content" id="article-content"></div>
        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
            <button id="like-btn" class="back-btn" style="background:#fff; color:#2b7cff; border:1px solid #2b7cff; padding:6px 12px;">ğŸ‘ ç‚¹èµ</button>
            <span id="like-count" style="color:#6b7280;">0</span>
        </div>
    </article>
    <section id="comments-section">
        <div class="article-card" style="padding:16px;">
            <h2 style="margin:0 0 12px; font-size:1.1rem;">è¯„è®º</h2>
            <div id="comments-list" style="display:flex; flex-direction:column; gap:12px; margin-bottom:12px;">
                <!-- è¯„è®ºé¡¹ç”±è„šæœ¬å¡«å…… -->
            </div>

            <form id="comment-form" style="display:flex; flex-direction:column; gap:8px;">
                <textarea id="comment-input" rows="4" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." style="resize:vertical; padding:8px; font-size:14px;"></textarea>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button type="submit" class="back-btn" style="background:#2b7cff; color:#fff; border:none; padding:8px 14px;">æäº¤è¯„è®º</button>
                </div>
            </form>
        </div>
    </section>
</main>

<script src="/common.js"></script>
<script>
    const userCache = new Map();
    async function fetchUserName(uid) {
        if (!uid) return 'åŒ¿å';
        if (userCache.has(uid)) return userCache.get(uid);
        try {
            let rsp = await apiFetch(`/api/user/userInfo/${encodeURIComponent(uid)}`);
            if (rsp && typeof rsp === 'object' && rsp.code !== undefined && rsp.data !== undefined) rsp = rsp.data;
            const name = (rsp && (rsp.user_name || rsp.username || rsp.name || rsp.UserName || rsp.User_name)) || String(uid);
            userCache.set(uid, name);
            return name;
        } catch (_) {
            const fallback = String(uid);
            userCache.set(uid, fallback);
            return fallback;
        }
    }
    (async function () {
        let index = 0;
        let dragging = false;
        let startX = 0;
        let startTranslate = 0;
        let resizeTid = 0;
        await loadHeader('#header-container');

        const backBtn = document.getElementById('back-btn');
        backBtn.addEventListener('click', () => history.back());

        const params = new URLSearchParams(location.search);
        const articleId = parseInt(params.get('id') || '0', 10);
        if (!articleId) {
            document.getElementById('article-title').textContent = 'æ— æ•ˆå¸–å­ ID';
            return;
        }

        const galleryContainer = document.getElementById('gallery-container');
        const carousel = document.getElementById('carousel');
        const track = document.getElementById('carousel-track');
        const indicators = document.getElementById('carousel-indicators');
        const titleEl = document.getElementById('article-title');
        const metaEl = document.getElementById('article-meta');
        const contentEl = document.getElementById('article-content');

        const likeBtn = document.getElementById('like-btn');
        const likeCountEl = document.getElementById('like-count');
        const commentsListEl = document.getElementById('comments-list');
        const commentForm = document.getElementById('comment-form');
        const commentInput = document.getElementById('comment-input');

        let _detailObjectUrls = [];
        window.addEventListener('beforeunload', () => _detailObjectUrls.forEach(URL.revokeObjectURL));

        async function loadDetail() {
            try {
                let detail = await apiFetch(`/api/article/articleDetail/${articleId}`);
                if (detail && typeof detail === 'object' && detail.code !== undefined && detail.data !== undefined) detail = detail.data;
                if (!detail) throw new Error('æœªæ‰¾åˆ°å¸–å­');

                titleEl.textContent = detail.title || detail.Title || '(æ— æ ‡é¢˜)';
                metaEl.innerHTML = [
                    `ä½œè€…ï¼š${escapeHtml(String(detail.author || detail.Author || 'åŒ¿å'))}`,
                    `æ—¶é—´ï¼š${escapeHtml(String(detail.time || detail.Time || detail.created_at || 'æœªçŸ¥'))}`,
                    detail.section ? `ä¸“åŒºï¼š${escapeHtml(String(detail.section))}` : '',
                    typeof detail.look_num !== 'undefined' ? `æµè§ˆï¼š${detail.look_num}` : '',
                    typeof detail.like_num !== 'undefined' ? `ç‚¹èµï¼š${detail.like_num}` : ''
                ].filter(Boolean).join(' Â· ');
                contentEl.innerHTML = escapeHtml(detail.content || detail.Content || '').replace(/\n/g, '<br/>');

                // åˆå§‹åŒ–ç‚¹èµæŒ‰é’®çŠ¶æ€ä¸æ•°é‡
                likeCountEl.textContent = (typeof detail.like_num !== 'undefined') ? String(detail.like_num) : '0';
                likeBtn.dataset.liked = detail.if_like ? '1' : '0';
                updateLikeButton();

                // å›¾ç‰‡é€»è¾‘ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
                const pics = Array.isArray(detail.pictures) ? detail.pictures :
                    (Array.isArray(detail.Pictures) ? detail.Pictures : []);
                const fallback = detail.PictureUrl || detail.url || detail.Picture || detail.picture;
                const sources = pics.length ? pics : (fallback ? [fallback] : []);

                // æ¸…ç†æ—§
                track.innerHTML = '';
                indicators.innerHTML = '';
                _detailObjectUrls.forEach(URL.revokeObjectURL);
                _detailObjectUrls = [];

                if (!sources.length) {
                    galleryContainer.style.display = 'none';
                } else {
                    galleryContainer.style.display = '';
                    for (let i = 0; i < sources.length; i++) {
                        const key = sources[i];
                        try {
                            const resp = /^https?:\/\//i.test(key) ? await fetch(key) :
                                await fetch(`/api/article/articlePictures/${articleId}/${encodeURIComponent(key)}`);
                            if (!resp?.ok) continue;
                            const blob = await resp.blob();
                            const url = URL.createObjectURL(blob);
                            _detailObjectUrls.push(url);

                            const item = document.createElement('div');
                            item.className = 'carousel-item';
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = `å›¾ç‰‡${i + 1}`;
                            item.appendChild(img);
                            track.appendChild(item);

                            const dot = document.createElement('div');
                            dot.className = 'carousel-indicator';
                            dot.addEventListener('click', () => goto(i));
                            indicators.appendChild(dot);
                        } catch (_) {}
                    }
                    if (track.children.length === 0) galleryContainer.style.display = 'none';
                }

                // é‡æ–°è®¡ç®—è½®æ’­å°ºå¯¸å¹¶æ˜¾ç¤º
                if (track.children.length) {
                    sizeSlides();
                    goto(0, false);
                }
            } catch (err) {
                titleEl.textContent = err?.message || 'åŠ è½½å¤±è´¥';
                metaEl.textContent = '';
                contentEl.textContent = '';
                galleryContainer.style.display = 'none';
            }
        }

        function updateLikeButton() {
            const liked = likeBtn.dataset.liked === '1';
            likeBtn.textContent = liked ? 'âœ… å·²èµ' : 'ğŸ‘ ç‚¹èµ';
            likeBtn.style.opacity = liked ? '0.7' : '1';
        }

        async function toggleLike() {
            likeBtn.disabled = true;
            try {
                const payloadId = { id: Number(articleId) };
                const headers = { 'Content-Type': 'application/json' };

                // å‘é€ helperï¼Œè¿”å›åŸå§‹å“åº”
                const send = async (bodyObj) => {
                    return await apiFetch('/api/article/like', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(bodyObj)
                    });
                };

                let res = await send(payloadId);

                // ç»Ÿä¸€è§£åŒ… { code, data } ç»“æ„
                let data = res;
                if (data && typeof data === 'object' && data.code !== undefined && data.data !== undefined) data = data.data;

                // å¦‚æœæœåŠ¡å™¨è¿”å›å« "field id not set" æˆ–ç±»ä¼¼æç¤ºï¼Œå°è¯•ç”¨ article_id é‡å‘
                const errText = String((res && (res.message || res.error)) || '');
                if (/field\s+id\s+not\s+set/i.test(errText) || /id\s+not\s+set/i.test(errText)) {
                    res = await send({ article_id: Number(articleId) });
                    data = res;
                    if (data && typeof data === 'object' && data.code !== undefined && data.data !== undefined) data = data.data;
                }

                // æˆåŠŸååˆ‡æ¢æœ¬åœ°çŠ¶æ€ä¸è®¡æ•°ï¼ˆå³ä½¿åç«¯è¿”å›ä¸è§„èŒƒï¼Œä¹Ÿæ”¹å–„ UXï¼‰
                const likedNow = likeBtn.dataset.liked !== '1';
                likeBtn.dataset.liked = likedNow ? '1' : '0';
                const current = parseInt(likeCountEl.textContent || '0', 10);
                likeCountEl.textContent = String(Math.max(0, current + (likedNow ? 1 : -1)));
                updateLikeButton();
            } catch (err) {
                alert('ç‚¹èµå¤±è´¥ï¼š' + (err?.message || 'ç½‘ç»œé”™è¯¯'));
            } finally {
                likeBtn.disabled = false;
            }
        }

        async function loadComments() {
            commentsListEl.innerHTML = '<div style="color:#9ca3af;">åŠ è½½ä¸­...</div>';
            try {
                let rsp = await apiFetch(`/api/article/comments/${articleId}`);
                if (rsp && typeof rsp === 'object' && rsp.code !== undefined && rsp.data !== undefined) rsp = rsp.data;
                const comments = (rsp && Array.isArray(rsp.comments)) ? rsp.comments : (rsp && Array.isArray(rsp.Comments) ? rsp.Comments : []);
                await renderComments(comments);
            } catch (err) {
                commentsListEl.innerHTML = `<div style="color:#ef4444;">åŠ è½½è¯„è®ºå¤±è´¥</div>`;
            }
        }

        async function renderComments(comments) {
            if (!comments || comments.length === 0) {
                commentsListEl.innerHTML = '<div style="color:#6b7280;">è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥ç¬¬ä¸€ä¸ªè¯„è®ºå§ã€‚</div>';
                return;
            }
            commentsListEl.innerHTML = '';
            // å¹¶è¡Œè·å–æ‰€æœ‰éœ€è¦çš„ç”¨æˆ·åä»¥å‡å°‘ç­‰å¾…
            const uidList = comments.map(c => (c.uid || c.UID || null));
            const uniqueUids = Array.from(new Set(uidList.filter(Boolean)));
            await Promise.all(uniqueUids.map(uid => fetchUserName(uid)));

            for (const c of comments) {
                const item = document.createElement('div');
                item.style.borderTop = '1px solid #eef2f7';
                item.style.paddingTop = '8px';

                const header = document.createElement('div');
                header.style.color = '#6b7280';
                header.style.fontSize = '13px';
                header.style.marginBottom = '6px';

                const uid = c.uid || c.UID || null;
                let author = 'åŒ¿å';
                if (uid) author = await fetchUserName(uid);
                else if (c.author) author = String(c.author);

                const time = escapeHtml(String(c.created_at || c.CreatedAt || c.time || ''));
                header.textContent = `${author} Â· ${time}`;

                const content = document.createElement('div');
                content.style.whiteSpace = 'pre-wrap';
                content.style.color = '#2f3137';
                content.textContent = String(c.content || c.Content || '');

                item.appendChild(header);
                item.appendChild(content);
                commentsListEl.appendChild(item);
            }
        }

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = (commentInput.value || '').trim();
            if (!text) return alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
            const payload = {
                article_id: articleId,
                content: text,
                parent: 0,
                p_parent: 0
            };
            const btn = commentForm.querySelector('button[type="submit"]');
            btn.disabled = true;
            try {
                const headers = { 'Content-Type': 'application/json' };
                let res = await apiFetch('/api/article/sendComments', {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: headers,
                });
                if (res && typeof res === 'object' && res.code !== undefined && res.data !== undefined) {
                    if (res.code !== 0) throw new Error(res.message || 'æäº¤å¤±è´¥');
                }
                commentInput.value = '';
                await loadComments();
            } catch (err) {
                alert('æäº¤å¤±è´¥ï¼š' + (err?.message || 'ç½‘ç»œé”™è¯¯'));
            } finally {
                btn.disabled = false;
            }
        });

        likeBtn.addEventListener('click', toggleLike);

        // åˆå§‹åŒ–ï¼šåŠ è½½è¯¦æƒ…ä¸è¯„è®º
        await loadDetail();
        await loadComments();

        // --- ä»¥ä¸‹æ˜¯åŸè½®æ’­ç›¸å…³å‡½æ•°ï¼ˆä¿æŒåŸæœ‰å®ç°ï¼‰ ---

        function getFrameWidth() {
            const width = carousel.getBoundingClientRect().width;
            return width > 0 ? width : 1;
        }

        function syncIndicators() {
            Array.from(indicators.children).forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        function sizeSlides() {
            const frameW = getFrameWidth();
            Array.from(track.children).forEach((item) => {
                item.style.width = frameW + 'px';
            });
            track.style.width = (frameW * track.children.length) + 'px';
            track.style.transform = `translateX(${ -index * frameW }px)`;
            syncIndicators();
        }

        function goto(newIndex, animate = true) {
            const max = track.children.length - 1;
            index = Math.max(0, Math.min(max, newIndex));
            const frameW = getFrameWidth();
            track.style.transition = animate ? 'transform 320ms ease' : 'none';
            track.style.transform = `translateX(${ -index * frameW }px)`;
            syncIndicators();
        }

        function pointerDown(e) {
            if (track.children.length <= 1) return;
            dragging = true;
            startX = e.clientX;
            startTranslate = -index * getFrameWidth();
            track.style.transition = 'none';
            try { carousel.setPointerCapture(e.pointerId); } catch (_) {}
        }

        function pointerMove(e) {
            if (!dragging) return;
            const dx = e.clientX - startX;
            track.style.transform = `translateX(${startTranslate + dx}px)`;
        }

        function pointerUp(e) {
            if (!dragging) return;
            dragging = false;
            try { carousel.releasePointerCapture(e.pointerId); } catch (_) {}
            const dx = e.clientX - startX;
            const threshold = getFrameWidth() * 0.18;
            if (dx > threshold && index > 0) index--;
            else if (dx < -threshold && index < track.children.length - 1) index++;
            goto(index);
        }

        carousel.addEventListener('pointerdown', pointerDown);
        carousel.addEventListener('pointermove', pointerMove);
        carousel.addEventListener('pointerup', pointerUp);
        carousel.addEventListener('pointercancel', pointerUp);
        carousel.addEventListener('pointerleave', (e) => { if (dragging) pointerUp(e); });

        window.addEventListener('resize', () => {
            clearTimeout(resizeTid);
            resizeTid = setTimeout(() => {
                sizeSlides();
                goto(index, false);
            }, 120);
        });

        if (track.children.length) sizeSlides();

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>\"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }
    })();
</script>
</body>
</html>
