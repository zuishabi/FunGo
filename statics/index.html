<!doctype html>
<html lang="zh">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>è®ºå›ç¤ºä¾‹</title>
    <link rel="stylesheet" href="/common.css" />
</head>
<body>
<div id="header-container"></div>

<main>
    <section class="content">
        <h2 id="list-title">å¸–å­åˆ—è¡¨</h2>
        <div id="articles"></div>
        <div class="pager" id="pager">
            <button id="prev-page" class="primary">ä¸Šä¸€é¡µ</button>
            <div id="page-info">ç¬¬ 1 é¡µ</div>
            <button id="next-page" class="primary">ä¸‹ä¸€é¡µ</button>
        </div>
    </section>

    <aside class="sidebar">
        <div class="sections" id="sections-box">
            <h3>ä¸“åŒº</h3>
            <div id="sections-list"></div>
            <div style="margin-top:12px">
                <button id="new-post" class="primary" style="width:100%" onclick="location.href='/post'">å‘å¸ƒå¸–å­</button>
            </div>
        </div>
    </aside>
</main>

<script src="/common.js"></script>
<script>
    async function resolveUserName(authorId) {
        if (authorId === null || typeof authorId === 'undefined' || authorId === '') return 'åŒ¿å';
        try {
            const resp = await apiFetch(`/api/user/userInfo/${encodeURIComponent(authorId)}`);
            const info = resp?.data ?? resp?.user ?? resp;
            const name = info?.user_name || info?.UserName || info?.username || info?.nick || info?.nickname || info?.name;
            return name ? String(name) : `ç”¨æˆ·${authorId}`;
        } catch (e) {
            return `ç”¨æˆ·${authorId}`;
        }
    }

    (async function () {
        await loadHeader('#header-container');
        const sections = [{id:0,name:'çƒ­é—¨'},{id:1,name:'å…¨éƒ¨'},{id:2,name:'æŠ€æœ¯'},{id:3,name:'ç”Ÿæ´»'}];

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>\"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        async function refreshHeader() {
            const host = document.getElementById('header-container');
            if (!host) return;
            host.innerHTML = '';
            await loadHeader('#header-container');
        }

        function renderSections(activeId) {
            const box = document.getElementById('sections-list');
            box.innerHTML = '';
            sections.forEach((s) => {
                const div = document.createElement('div');
                div.className = 'section-item' + (s.id === activeId ? ' active' : '');
                div.textContent = s.name;
                div.style.cursor = 'pointer';
                // ç›´æ¥è·³è½¬åˆ°æ ‡å‡† section è·¯ç”±ï¼Œé¿å…ä¸­é—´ /hot å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
                div.addEventListener('click', () => {
                    location.hash = `/section/${s.id}/page/1`;
                });
                box.appendChild(div);
            });
        }

        function parseHash() {
            const h = location.hash.replace(/^#/, '');
            if (!h || h === '/' || h === '/posts') return { route: 'list', section: 1, page: 1 };
            const parts = h.split('/').filter(Boolean);
            if (parts[0] === 'hot') return { route: 'list', section: 0, page: 1 };
            if (parts[0] === 'section') {
                const sid = Number.isFinite(Number(parts[1])) ? Number(parts[1]) : 1;
                const pageIndex = (parts[2] === 'page' && Number.isFinite(Number(parts[3]))) ? Number(parts[3]) : 1;
                return { route: 'list', section: sid, page: pageIndex };
            }
            if (parts[0] === 'article') return { route: 'detail', id: Number.isFinite(Number(parts[1])) ? Number(parts[1]) : 0 };
            return { route: 'list', section: 1, page: 1 };
        }

        async function loadArticles(sectionId, page) {
            const PAGE_SIZE = 10;
            document.getElementById('list-title').textContent = (sections.find(s => s.id === sectionId)?.name || ('ä¸“åŒº ' + sectionId)) + ' å¸–å­';
            const container = document.getElementById('articles');
            container.innerHTML = 'åŠ è½½ä¸­...';

            try {
                let data = await apiFetch(`/api/article/articleList/${sectionId}/${page}`);
                if (data && typeof data === 'object' && data.code !== undefined && data.data !== undefined) data = data.data;
                let arr = [];
                if (Array.isArray(data)) arr = data;
                else if (data?.articles) arr = data.articles;
                else if (data?.Articles) arr = data.Articles;
                const shown = arr.slice(0, PAGE_SIZE);

                if (shown.length === 0) {
                    container.innerHTML = '<div style="padding:12px;color:#666">æš‚æ— å¸–å­</div>';
                    document.getElementById('page-info').textContent = `ç¬¬ ${page} é¡µ`;
                    document.getElementById('prev-page').disabled = page <= 1;
                    document.getElementById('next-page').disabled = true;
                    return;
                }

                container.innerHTML = '';
                for (const a of shown) {
                    const aid = a.id || a.ID || a.article_id || 0;
                    const card = document.createElement('div');
                    card.className = 'post-card';
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', () => {
                        try { sessionStorage.setItem('lastListHash', location.hash || `/section/${sectionId}/page/${page}`); } catch (e) {}
                        location.href = `/articleDetail?id=${aid}`;
                    });

                    const authorId = a.author || a.Author;
                    const header = document.createElement('div');
                    header.className = 'post-header';
                    resolveUserName(authorId).then((resolved) => {
                        header.innerHTML = `<div class="avatar">${escapeHtml((resolved || 'U')[0])}</div><div class="user-name">${escapeHtml(resolved)}</div>`;
                    });
                    card.appendChild(header);

                    const t = document.createElement('div');
                    t.className = 'post-title';
                    t.textContent = a.title || a.Title || '(æ— æ ‡é¢˜)';
                    card.appendChild(t);

                    const sr = document.createElement('div');
                    sr.className = 'post-summary-row';
                    const summary = document.createElement('div');
                    summary.className = 'post-summary';
                    summary.textContent = (a.summary || a.Summary || a.desc || a.content || '').slice(0, 60);
                    sr.appendChild(summary);

                    const thumbWrap = document.createElement('div');
                    thumbWrap.className = 'post-thumb';
                    sr.appendChild(thumbWrap);
                    card.appendChild(sr);

                    (async () => {
                        try {
                            const infoUrl = a.url || a.PictureUrl || a.picture;
                            if (!infoUrl) return;
                            const img = document.createElement('img');
                            img.src = `/api/article/articlePictures/${aid}/${encodeURIComponent(infoUrl)}`;
                            img.alt = 'thumb';
                            img.className = 'thumb-multi';
                            thumbWrap.appendChild(img);
                        } catch (_) {}
                    })();

                    const meta = document.createElement('div');
                    meta.className = 'post-meta-row';
                    const left = document.createElement('div');
                    left.className = 'meta-left';
                    const sectName = sections.find(x => x.id === (a.section || a.Section))?.name || ('ä¸“åŒº ' + (a.section || a.Section || 1));
                    left.innerHTML = `<span class="meta-section">${escapeHtml(sectName)}</span><span class="meta-time">${escapeHtml(String(a.time || a.Time || ''))}</span>`;
                    const right = document.createElement('div');
                    right.className = 'meta-right';
                    right.innerHTML = `<span>ğŸ‘ ${a.like_num || a.LikeNum || 0}</span><span style="margin-left:12px">ğŸ’¬ ${a.comment_num || a.CommentNum || 0}</span>`;
                    meta.appendChild(left);
                    meta.appendChild(right);
                    card.appendChild(meta);

                    container.appendChild(card);
                }

                document.getElementById('page-info').textContent = `ç¬¬ ${page} é¡µ`;
                const prevBtn = document.getElementById('prev-page');
                const nextBtn = document.getElementById('next-page');
                prevBtn.disabled = page <= 1;
                nextBtn.disabled = sectionId === 0 || shown.length < PAGE_SIZE;
                prevBtn.onclick = () => {
                    if (prevBtn.disabled) return;
                    location.hash = sectionId === 0 ? '/hot' : `/section/${sectionId}/page/${page - 1}`;
                };
                nextBtn.onclick = () => {
                    if (nextBtn.disabled) return;
                    if (sectionId === 0) return;
                    location.hash = `/section/${sectionId}/page/${page + 1}`;
                };
            } catch (err) {
                document.getElementById('articles').innerHTML = `<div style="padding:12px;color:#d9534f">${escapeHtml(err?.message || err)}</div>`;
            }
        }

        function onRouteChange() {
            const p = parseHash();

            // è§„èŒƒåŒ– hot è·¯ç”±ï¼ˆå¦‚æœè¿˜æœ‰ /hot çš„å†å²æƒ…å†µï¼Œä¹Ÿç»Ÿä¸€åˆ° /section/0/page/1ï¼‰
            if (p.route === 'list' && p.section === 0 && location.hash !== '#/section/0/page/1') {
                location.hash = '/section/0/page/1';
                return;
            }

            if (p.route === 'detail' && p.id) {
                renderSections(null);
                document.getElementById('pager').style.display = 'none';
                return;
            }

            try {
                sessionStorage.setItem('lastListHash', location.hash || `/section/${(p.section ?? 1)}/page/${(p.page ?? 1)}`);
            } catch (e) {}

            const section = (p.section ?? 1);
            const page = (p.page ?? 1);

            // çƒ­é—¨ï¼ˆsection === 0ï¼‰æ—¶éšè—åˆ†é¡µæ ï¼Œå¦åˆ™æ˜¾ç¤º
            document.getElementById('pager').style.display = section === 0 ? 'none' : '';

            renderSections(section);
            loadArticles(section, page);
        }

        window.addEventListener('hashchange', onRouteChange);
        if (!location.hash) location.hash = '/section/1/page/1';
        else onRouteChange();
    })();
</script>
</body>
</html>
