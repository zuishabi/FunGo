<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>直播间</title>
    <link rel="stylesheet" href="/common.css">
    <script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>

    <style>
        :root{
            --bg: #0b1020;
            --card: #0f172a;
            --card2:#111c33;
            --text:#e5e7eb;
            --muted:#9ca3af;
            --border:#22304a;
            --accent:#60a5fa;
        }

        html, body { height: 100%; }
        body{ margin: 0; background: var(--bg); color: var(--text); }

        .page{
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            box-sizing: border-box;
        }

        .topbar{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
            margin: 6px 0 12px 0;
        }

        .btn{
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.03);
            color: var(--text);
            border-radius: 10px;
            cursor: pointer;
        }
        .btn:hover{ border-color: rgba(96,165,250,0.6); }

        .layout{
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 12px;
            align-items: start;
        }
        @media (max-width: 980px){
            .layout{ grid-template-columns: 1fr; }
        }

        .player-card{
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }

        .player-header{
            display:flex;
            gap:12px;
            align-items:center;
            justify-content:space-between;
            padding: 12px 12px 10px 12px;
            border-bottom: 1px solid rgba(34,48,74,0.8);
            background: rgba(17,28,51,0.35);
        }

        .player-head{
            display:flex;
            align-items:center;
            justify-content:flex-start;
            gap: 12px;
            min-width:0;
            flex: 1 1 auto;
        }
        .player-head-cover{
            flex: 0 0 auto;
            width: 132px;
            height: 74px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(34,48,74,0.9);
            background: rgba(0,0,0,0.35);
        }
        #room-cover-img{
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .player-head-text{
            min-width:0;
            flex: 1 1 auto;
        }
        .player-title{
            font-size: 15px;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
        }
        .player-sub{
            margin: 4px 0 0 0;
            font-size: 12px;
            color: var(--muted);
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
        }
        @media (max-width: 640px){
            .player-head-cover{ display:none; }
        }

        /* 播放器壳：只放 video + 弹幕层 */
        .player-body{
            position: relative;
            background: #000;
            aspect-ratio: 16/9;
            overflow: hidden;
        }

        /* 不要 controls：隐藏进度条/暂停键等 */
        #video-element{
            width: 100%;
            height: 100%;
            display:block;
            background:#000;
        }
        /* 兜底（部分 WebKit 仍会渲染控件） */
        #video-element::-webkit-media-controls { display:none !important; }
        #video-element::-webkit-media-controls-enclosure { display:none !important; }
        #video-element::-webkit-media-controls-panel { display:none !important; }

        .danmu-layer{
            position:absolute;
            inset:0;
            pointer-events:none;
            overflow:hidden;
            z-index: 20;
        }
        .danmu-item{
            position:absolute;
            left: 100%;
            white-space: nowrap;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.2px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.4);
            opacity: 0.98;
            transform: translateZ(0);
            animation-name: danmu-move;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            will-change: transform;
        }
        .danmu-item.small{ font-size: 16px; font-weight: 600; }
        .danmu-item.big{ font-size: 20px; font-weight: 700; }

        @keyframes danmu-move{
            from{ transform: translateX(0); }
            to{ transform: translateX(calc(-100vw - 200%)); }
        }

        .playlist-card{
            background: var(--card) !important;
            color: var(--text) !important;
            border: 1px solid var(--border) !important;
            border-radius: 14px;
            overflow: hidden;
        }
        .playlist-header{
            background: rgba(17,28,51,0.70) !important;
            color: var(--text) !important;
            padding: 12px !important;
            border-bottom: 1px solid rgba(34,48,74,0.8) !important;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
        }
        .playlist-title{
            font-size: 14px;
            font-weight: 800;
            margin: 0;
            color: var(--text) !important;
        }
        .danmu-list{
            background: var(--card2) !important;
            color: var(--text) !important;
            max-height: 520px;
            overflow: auto;
            padding: 6px 0;
        }
        .danmu-row{
            padding: 8px 12px;
            border-bottom: 1px solid rgba(34,48,74,0.75);
            font-size: 12px;
            line-height: 1.5;
            word-break: break-word;
            background: var(--card2) !important;
            color: var(--text) !important;
        }
        .danmu-row:nth-child(odd){
            background: rgba(255,255,255,0.02) !important;
        }
        .danmu-row .name{
            color: var(--accent) !important;
            font-weight: 800;
            margin-right: 6px;
        }
        .danmu-row .content{
            background: transparent !important;
            color: var(--text) !important;
        }

        /* 输入框：非全屏时，固定显示在播放器下方（不再放进 .player-body 里） */
        .composer{
            margin-top: 12px;
            background: rgba(17,28,51,0.35);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            display: block;
        }
        .composer-grid{
            display:grid;
            grid-template-columns: 1fr 110px;
            gap: 10px;
            align-items:center;
        }
        @media (max-width: 640px){
            .composer-grid{ grid-template-columns: 1fr; }
        }
        .input{
            width:100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(34,48,74,0.9);
            background: rgba(0,0,0,0.25);
            color: var(--text);
            outline: none;
            box-sizing: border-box;
        }
        .input:focus{
            border-color: rgba(96,165,250,0.7);
            box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
        }
        .send{
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(96,165,250,0.65);
            background: rgba(96,165,250,0.16);
            color: var(--text);
            cursor:pointer;
            font-weight:800;
        }
        .send:hover{ background: rgba(96,165,250,0.22); }

        .roominfo{
            margin-top: 12px;
            background: rgba(17,28,51,0.35);
            border: 1px solid rgba(34,48,74,0.75);
            border-radius: 14px;
            padding: 12px;
            color: var(--text);
        }
        .roominfo h2{ margin:0 0 6px 0; font-size: 16px; }
        .roominfo p{
            margin:0;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .roominfo .tip{
            margin-top: 8px;
            color: rgba(252, 211, 77, 0.95);
            display: none;
        }

        /* 全屏：弹幕覆盖，输入框固定底部（输入框会被 JS 临时移入 player-shell） */
        #player-shell:fullscreen{
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        #player-shell:-webkit-full-screen{
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        #player-shell:fullscreen #video-element,
        #player-shell:-webkit-full-screen #video-element{
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #player-shell:fullscreen .danmu-layer,
        #player-shell:-webkit-full-screen .danmu-layer{
            position: absolute;
            inset: 0;
            z-index: 20;
        }
        #player-shell:fullscreen #composer,
        #player-shell:-webkit-full-screen #composer{
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 30;
            margin: 0;
            padding: 10px;
            border: 0;
            border-radius: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.65));
            display: block;
        }
        #player-shell:fullscreen .input,
        #player-shell:-webkit-full-screen .input{
            background: rgba(0,0,0,0.55);
        }
    </style>
</head>

<body>
<div id="header-container"></div>

<div class="page">
    <div class="topbar">
        <button type="button" id="btn-back" class="btn">返回</button>
        <div style="color: var(--muted); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            roomId: <span id="room-id-view"></span>
        </div>
    </div>

    <div class="layout">
        <div>
            <div class="player-card">
                <div class="player-header">
                    <div class="player-head">
                        <div class="player-head-cover">
                            <img id="room-cover-img" alt="封面" />
                        </div>
                        <div class="player-head-text">
                            <p id="room-title" class="player-title">加载中...</p>
                            <p id="room-anchor" class="player-sub"></p>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px; align-items:center;">
                        <button type="button" id="btn-toggle-danmu" class="btn">弹幕: 开</button>
                        <button type="button" id="btn-fullscreen" class="btn">全屏</button>
                    </div>
                </div>

                <div class="player-body" id="player-shell">
                    <video id="video-element" autoplay muted playsinline controlslist="nodownload noplaybackrate noremoteplayback"></video>
                    <div id="danmu-layer" class="danmu-layer"></div>
                </div>
            </div>

            <!-- 非全屏时：输入框在播放器下方，确保可见 -->
            <div class="composer" id="composer">
                <div class="composer-grid">
                    <input id="danmu-content" class="input" type="text" placeholder="输入弹幕内容..." />
                    <button id="danmu-send" class="send" type="button">发送</button>
                </div>
            </div>

            <div class="roominfo">
                <h2>直播间信息</h2>
                <p id="room-description">加载中...</p>
                <p id="room-tip" class="tip"></p>
            </div>
        </div>

        <div class="playlist-card">
            <div class="playlist-header">
                <p class="playlist-title">弹幕列表</p>
                <button type="button" id="btn-clear-danmu" class="btn">清空</button>
            </div>
            <div id="danmu-list" class="danmu-list"></div>
        </div>
    </div>
</div>

<script src="/common.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        if (typeof loadHeader === 'function') {
            await loadHeader('#header-container');
        }

        const $ = (id) => document.getElementById(id);
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('roomId');

        const roomIdView = $('room-id-view');
        if (roomIdView) roomIdView.textContent = roomId || '-';

        const backBtn = $('btn-back');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                if (window.history.length > 1) window.history.back();
                else window.location.href = '/';
            });
        }

        const titleEl = $('room-title');
        const anchorEl = $('room-anchor');
        const descEl = $('room-description');
        const tipEl = $('room-tip');
        const coverImgEl = $('room-cover-img');

        const danmuLayer = $('danmu-layer');
        const toggleBtn = $('btn-toggle-danmu');
        const fsBtn = $('btn-fullscreen');

        const danmuContentEl = $('danmu-content');
        const danmuSendBtn = $('danmu-send');

        const danmuListEl = $('danmu-list');
        const clearDanmuBtn = $('btn-clear-danmu');

        const shell = $('player-shell');
        const videoEl = $('video-element');
        const composerEl = $('composer');

        let flvPlayer = null;
        let sseSource = null;
        let danmuEnabled = true;

        const composerHome = composerEl ? composerEl.parentElement : null;
        const composerNext = composerEl ? composerEl.nextSibling : null;

        function isFullscreenShell() {
            return document.fullscreenElement === shell || document.webkitFullscreenElement === shell;
        }

        function moveComposerForFullscreen() {
            if (!composerEl || !shell || !composerHome) return;
            if (isFullscreenShell()) {
                if (composerEl.parentElement !== shell) shell.appendChild(composerEl);
            } else {
                if (composerEl.parentElement === shell) {
                    if (composerNext) composerHome.insertBefore(composerEl, composerNext);
                    else composerHome.appendChild(composerEl);
                }
            }
        }

        function showTip(msg) {
            if (!tipEl) return;
            const t = String(msg || '').trim();
            if (!t) {
                tipEl.style.display = 'none';
                tipEl.textContent = '';
                return;
            }
            tipEl.textContent = t;
            tipEl.style.display = 'block';
        }

        function setCover(rid, coverValue) {
            if (!coverImgEl) return;
            const v = String(coverValue || '').trim();
            if (!v) {
                coverImgEl.style.display = 'none';
                coverImgEl.removeAttribute('src');
                return;
            }

            const isAbs = /^https?:\/\//i.test(v);
            const name = v.split('/').pop();
            const url = isAbs ? v : `/api/live/CoverPicture/${encodeURIComponent(rid)}/${encodeURIComponent(name)}`;

            coverImgEl.onload = () => { coverImgEl.style.display = 'block'; };
            coverImgEl.onerror = () => {
                coverImgEl.style.display = 'none';
                coverImgEl.removeAttribute('src');
            };
            coverImgEl.src = url;
        }

        const lanes = 9;
        const laneBusyUntil = new Array(lanes).fill(0);

        function pickLane() {
            const now = Date.now();
            let bestIdx = 0;
            let bestTime = laneBusyUntil[0];
            for (let i = 0; i < lanes; i++) {
                if (laneBusyUntil[i] <= now) return i;
                if (laneBusyUntil[i] < bestTime) {
                    bestTime = laneBusyUntil[i];
                    bestIdx = i;
                }
            }
            return bestIdx;
        }

        function pushDanmuOverlay(content) {
            if (!danmuEnabled || !danmuLayer) return;
            const t = String(content || '').trim();
            if (!t) return;

            const item = document.createElement('div');
            item.className = 'danmu-item';

            const r = Math.random();
            if (r < 0.15) item.classList.add('big');
            else if (r < 0.45) item.classList.add('small');

            item.textContent = t;

            const lane = pickLane();
            item.style.top = (12 + lane * 26) + 'px';

            const base = 8.5;
            const extra = Math.min(8, t.length / 10);
            const duration = base + extra + (Math.random() * 2.0);
            item.style.animationDuration = duration + 's';

            laneBusyUntil[lane] = Date.now() + Math.max(600, (duration * 1000) * 0.45);

            danmuLayer.appendChild(item);
            item.addEventListener('animationend', () => {
                try { item.remove(); } catch (e) {}
            });
        }

        function appendDanmuList(userName, content) {
            if (!danmuListEl) return;

            const name = String(userName || '').trim() || '未知用户';
            const text = String(content || '').trim();
            if (!text) return;

            const row = document.createElement('div');
            row.className = 'danmu-row';

            const nameSpan = document.createElement('span');
            nameSpan.className = 'name';
            nameSpan.textContent = name + ':';

            const contentSpan = document.createElement('span');
            contentSpan.className = 'content';
            contentSpan.textContent = ' ' + text;

            row.appendChild(nameSpan);
            row.appendChild(contentSpan);

            danmuListEl.appendChild(row);
            danmuListEl.scrollTop = danmuListEl.scrollHeight;
        }

        function parseSsePayload(raw) {
            const s = String(raw || '').trim();
            if (!s) return null;

            let obj = null;
            try { obj = JSON.parse(s); }
            catch (_) { return { userName: '未知用户', content: s }; }

            const data = (obj && typeof obj === 'object' && 'data' in obj) ? obj.data : obj;
            if (!data || typeof data !== 'object') return null;

            const userName = data.user_name ?? data.UserName ?? '';
            const content = data.content ?? data.Content ?? '';

            return { userName: String(userName || ''), content: String(content || '') };
        }

        function connectDanmuSSE(rid) {
            if (!rid) return;

            if (sseSource) {
                try { sseSource.close(); } catch (e) {}
                sseSource = null;
            }

            const url = `/api/live/BulletChatMessage/${encodeURIComponent(rid)}`;
            sseSource = new EventSource(url);

            sseSource.onmessage = function (event) {
                const parsed = parseSsePayload(event.data);
                if (!parsed) return;

                pushDanmuOverlay(parsed.content);
                appendDanmuList(parsed.userName, parsed.content);
            };

            sseSource.onerror = function () {};
        }

        async function sendDanmu(rid) {
            if (!danmuContentEl) return;

            const content = String(danmuContentEl.value || '').trim();
            if (!rid || !content) return;

            try {
                showTip('');
                await window.apiFetch('/api/live/SendBulletChat', {
                    method: 'POST',
                    body: { room_id: Number(rid), content: content }
                });
                danmuContentEl.value = '';
            } catch (e) {
                const msg = String(e?.message || '');
                if (msg.includes('401') || msg.includes('403') || msg.includes('未登录') || msg.toLowerCase().includes('token')) {
                    showTip('请先登录才能发送弹幕');
                } else {
                    showTip(msg || '发送失败');
                }
            }
        }

        function initPlayer(streamKey) {
            if (!videoEl) return;

            // 明确不显示控制条
            videoEl.removeAttribute('controls');

            if (flvPlayer) {
                try { flvPlayer.destroy(); } catch (e) {}
                flvPlayer = null;
            }

            if (!window.flvjs || !flvjs.isSupported()) {
                if (titleEl) titleEl.textContent = '浏览器不支持 FLV 播放';
                return;
            }

            const streamUrl = `/live/${encodeURIComponent(streamKey)}.flv`;
            flvPlayer = flvjs.createPlayer({ type: 'flv', isLive: true, url: streamUrl });

            flvPlayer.on(flvjs.Events.ERROR, function () {
                if (titleEl) titleEl.textContent = '拉流失败（502/504 或上游不可用）';
            });

            flvPlayer.attachMediaElement(videoEl);
            flvPlayer.load();
            flvPlayer.play().catch(() => {});
        }

        async function fetchRoomDetailsAndPlay(id) {
            const response = await fetch(`/api/live/liveRoom/${encodeURIComponent(id)}`);
            if (!response.ok) return;

            const body = await response.json().catch(() => null);
            if (!body || body.code !== 0) return;

            const data = body.data || {};

            if (titleEl) titleEl.textContent = data.title || '无标题直播间';

            const userName = data.user_name ?? data.UserName ?? '';
            if (anchorEl) anchorEl.textContent = userName ? (`主播：${userName}`) : '';

            if (descEl) descEl.textContent = String(data.description || '').trim() || '暂无简介';

            document.title = data.title || '直播间';

            const cover = data.cover ?? data.Cover ?? '';
            setCover(id, cover);

            const streamKey = data.key ?? data.Key;
            if (streamKey) initPlayer(streamKey);
        }

        function toggleFullscreen() {
            if (!shell) return;
            const isFs = isFullscreenShell();
            if (!isFs) {
                const req = shell.requestFullscreen || shell.webkitRequestFullscreen;
                if (req) req.call(shell);
            } else {
                const exit = document.exitFullscreen || document.webkitExitFullscreen;
                if (exit) exit.call(document);
            }
        }

        document.addEventListener('fullscreenchange', moveComposerForFullscreen);
        document.addEventListener('webkitfullscreenchange', moveComposerForFullscreen);

        if (fsBtn) fsBtn.addEventListener('click', toggleFullscreen);

        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                danmuEnabled = !danmuEnabled;
                toggleBtn.textContent = danmuEnabled ? '弹幕: 开' : '弹幕: 关';
                if (!danmuEnabled && danmuLayer) danmuLayer.innerHTML = '';
            });
        }

        if (danmuSendBtn) danmuSendBtn.addEventListener('click', () => sendDanmu(roomId));
        if (danmuContentEl) {
            danmuContentEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendDanmu(roomId);
            });
        }

        if (clearDanmuBtn) {
            clearDanmuBtn.addEventListener('click', () => {
                if (danmuLayer) danmuLayer.innerHTML = '';
                if (danmuListEl) danmuListEl.innerHTML = '';
            });
        }

        window.addEventListener('beforeunload', () => {
            if (sseSource) {
                try { sseSource.close(); } catch (e) {}
                sseSource = null;
            }
            if (flvPlayer) {
                try { flvPlayer.destroy(); } catch (e) {}
                flvPlayer = null;
            }
        });

        // 初始状态：确保非全屏时 composer 在外面可见
        moveComposerForFullscreen();

        if (!roomId) return;

        connectDanmuSSE(roomId);
        await fetchRoomDetailsAndPlay(roomId);
    });
</script>
</body>
</html>
