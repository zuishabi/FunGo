<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/common.css" />
    <title>ä¸ªäººä¸»é¡µ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f6f8;
        }

        .page-wrap{
            max-width: 980px;
            margin: 0 auto;
            padding: 16px;
        }

        .navbar {
            display: flex;
            background-color: #333;
            padding: 10px;
            border-radius: 10px;
        }
        .navbar a {
            color: white;
            padding: 10px 14px;
            text-decoration: none;
            cursor: pointer;
            border-radius: 8px;
        }
        .navbar a:hover {
            background-color: #575757;
        }

        .content {
            margin-top: 14px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }

        /* ä¸ªäººä¿¡æ¯å¡ç‰‡ */
        .profile-card{
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(17,24,39,0.06);
            display: flex;
            gap: 16px;
            align-items: center;
            margin: 14px 0;
        }

        .avatar-wrap{
            width: 88px;
            height: 88px;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            flex: 0 0 auto;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            cursor: pointer;
        }

        .avatar-wrap img{
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-mask{
            position: absolute;
            inset: 0;
            background: rgba(17,24,39,0.55);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.15s ease;
            user-select: none;
        }

        .avatar-wrap:hover .avatar-mask{
            opacity: 1;
        }

        .profile-main{
            flex: 1 1 auto;
            min-width: 0;
        }

        .profile-title{
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .profile-grid{
            display: grid;
            grid-template-columns: 96px 1fr;
            gap: 6px 12px;
            font-size: 14px;
            color: #374151;
        }
        .profile-label{
            color: #6b7280;
        }

        .hint{
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
        }

        /* ä¿æŒåŸæœ‰åŒºåŸŸ */
        #articles .post-card { margin-top: 12px; }
    </style>
</head>

<body>
<div id="header-container"></div> <!-- åŠ è½½å¤´éƒ¨ -->

<div class="page-wrap">
    <div id="userinfo">
        <div class="profile-card">
            <div id="avatarWrap" class="avatar-wrap" title="ç‚¹å‡»ä¸Šä¼ æ–°å¤´åƒ">
                <img id="userAvatar" alt="avatar" />
                <div class="avatar-mask">ç¼–è¾‘å¤´åƒ</div>
            </div>

            <div class="profile-main">
                <div class="profile-title">ä¸ªäººä¿¡æ¯</div>
                <div id="user-info" class="profile-grid"></div>
            </div>
        </div>

        <!-- éšè—æ–‡ä»¶é€‰æ‹© -->
        <input id="avatarFileInput" type="file" accept="image/*" style="display:none" />
    </div>

    <div class="content">
        <div class="navbar">
            <a onclick="showSection('articles')">å¸–å­å‘å¸ƒ</a>
            <a onclick="showSection('games')">æ¸¸æˆåˆ†äº«</a>
            <a onclick="showSection('live')">ç›´æ’­é—´</a>
        </div>

        <div id="articles" class="section active">
            <h2>å¸–å­å‘å¸ƒ</h2>
            <div id="article-list"></div>
        </div>

        <div id="games" class="section">
            <h2>æ¸¸æˆåˆ†äº«</h2>
            <p>è¿™é‡Œæ˜¯æ¸¸æˆåˆ†äº«å†…å®¹ã€‚</p>
        </div>

        <div id="live" class="section">
            <h2>ç›´æ’­é—´</h2>
            <div id="live-room"></div>
        </div>
    </div>
</div>

    <script src="/common.js"></script>
    <script>
        // æ˜¾ç¤ºå¯¹åº”çš„æ ç›®
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // ä» URL ä¸­è§£æ uid
        function getUidFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('uid') || '0';
        }

        function setAvatarSrc(uid) {
            const img = document.getElementById('userAvatar');
            // åŠ æ—¶é—´æˆ³é¿å…æµè§ˆå™¨ç¼“å­˜æ—§å¤´åƒ
            img.src = `/api/user/userCover/${encodeURIComponent(uid)}?t=${Date.now()}`;
            img.onerror = () => {
                // å¤´åƒä¸å­˜åœ¨æ—¶ç»™ä¸€ä¸ªç°åº•å ä½
                img.removeAttribute('src');
            };
        }

        async function fetchUserInfo() {
            const uid = getUidFromUrl();
            if (!uid) return;

            try {
                const data = await apiFetch(`/api/user/userInfo/${encodeURIComponent(uid)}`);
                const userName = data.user_name ?? '';
                const userId = data.user_id ?? uid;

                document.getElementById('user-info').innerHTML = `
                <div class="profile-label">ç”¨æˆ·å</div><div>${userName || 'åŒ¿å'}</div>
                <div class="profile-label">ç”¨æˆ·ID</div><div>${userId}</div>
            `;

                setAvatarSrc(userId);
            } catch (error) {
                document.getElementById('user-info').innerHTML = `<div style="grid-column:1/-1;color:#d9534f">è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š${error.message}</div>`;
            }
        }

        function bindAvatarUpload() {
            const uid = getUidFromUrl();
            const avatarWrap = document.getElementById('avatarWrap');
            const input = document.getElementById('avatarFileInput');

            avatarWrap.addEventListener('click', () => {
                input.value = '';
                input.click();
            });

            input.addEventListener('change', async () => {
                const file = input.files && input.files[0];
                if (!file) return;

                const form = new FormData();
                form.append('cover', file);

                try {
                    // ä¾èµ– common.js çš„ apiFetchï¼šéœ€è¦èƒ½å‘é€ FormData
                    await apiFetch(`/api/user/editUserCover`, {
                        method: 'POST',
                        body: form
                    });

                    // ä¸Šä¼ æˆåŠŸååˆ·æ–°å¤´åƒ
                    setAvatarSrc(uid);
                } catch (e) {
                    alert(`ä¸Šä¼ å¤´åƒå¤±è´¥ï¼š${e.message || e}`);
                }
            });
        }

        async function resolveUserName(authorId) {
            if (authorId === null || typeof authorId === 'undefined' || authorId === '') return 'åŒ¿å';
            try {
                const resp = await apiFetch(`/api/user/userInfo/${encodeURIComponent(authorId)}`);
                const info = resp?.data ?? resp?.user ?? resp;
                const name = info?.user_name || info?.UserName || info?.username || info?.nick || info?.nickname || info?.name;
                return name ? String(name) : `ç”¨æˆ·${authorId}`;
            } catch (e) {
                return `ç”¨æˆ·${authorId}`;
            }
        }

        // è·å–å¸–å­åˆ—è¡¨
        async function fetchUserArticles() {
            const uid = getUidFromUrl();
            try {

                const data = await apiFetch(`/api/article/userArticleList/${uid}/1`);
                const articles = data.articles || [];
                const container = document.getElementById('article-list');
                if (articles.length === 0) {
                    container.innerHTML = '<div style="padding:12px;color:#666">æš‚æ— å¸–å­</div>';
                    return;
                }

                container.innerHTML = '';
                articles.forEach(article => {
                    const card = document.createElement('div');
                    card.className = 'post-card';
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', () => {
                        location.href = `/articleDetail?id=${article.id}`;
                    });

                    const header = document.createElement('div');
                    header.className = 'post-header';

    // å¼‚æ­¥è·å–ç”¨æˆ·å
                    resolveUserName(article.author).then((resolvedName) => {
                        header.innerHTML = `
            <div class="avatar">${(resolvedName || 'U')[0]}</div>
            <div class="user-name">${resolvedName || 'åŒ¿å'}</div>
        `;
                    });

                    card.appendChild(header);

                    const title = document.createElement('div');
                    title.className = 'post-title';
                    title.textContent = article.title || '(æ— æ ‡é¢˜)';
                    card.appendChild(title);

                    const summaryRow = document.createElement('div');
                    summaryRow.className = 'post-summary-row';
                    const summary = document.createElement('div');
                    summary.className = 'post-summary';
                    summary.textContent = (article.summary || '').slice(0, 60);
                    summaryRow.appendChild(summary);

                    const thumbWrap = document.createElement('div');
                    thumbWrap.className = 'post-thumb';
                    if (article.url) {
                        const img = document.createElement('img');
                        img.src = `/api/article/articlePictures/${article.id}/${encodeURIComponent(article.url)}`;
                        img.alt = 'thumb';
                        img.className = 'thumb-multi';
                        thumbWrap.appendChild(img);
                    }
                    summaryRow.appendChild(thumbWrap);
                    card.appendChild(summaryRow);

                    const meta = document.createElement('div');
                    meta.className = 'post-meta-row';
                    meta.innerHTML = `
                    <div class="meta-left">
                        <span class="meta-section">ä¸“åŒº ${article.section || 1}</span>
                        <span class="meta-time">${article.time || ''}</span>
                    </div>
                    <div class="meta-right">
                        <span>ğŸ‘ ${article.like_num || 0}</span>
                        <span style="margin-left:12px">ğŸ’¬ ${article.comment_num || 0}</span>
                    </div>
                `;
                    card.appendChild(meta);

                    container.appendChild(card);
                });
            } catch (error) {
                console.error('è·å–å¸–å­åˆ—è¡¨å¤±è´¥:', error.message);
                document.getElementById('article-list').innerHTML = `<div style="padding:12px;color:#d9534f">${error.message}</div>`;
            }
        }

        // è·å–ç›´æ’­é—´ä¿¡æ¯
        async function fetchLiveRoom() {
            const uid = getUidFromUrl();
            if (!uid) {
                console.error('æœªæ‰¾åˆ°ç”¨æˆ· UID');
                return;
            }
            try {
                const data = await apiFetch(`/api/live/UserLiveRoom/${uid}`);
                const container = document.getElementById('live-room');

                if (!data || data.state === 0) {
                    container.innerHTML = '<div style="padding:12px;color:#666">æœªåˆ›å»ºç›´æ’­é—´</div>';
                    return;
                }

                // ç”Ÿæˆå°é¢å›¾ç‰‡ URL
                const coverUrl = data.cover
                    ? `/api/live/CoverPicture/${encodeURIComponent(data.room_id)}/${encodeURIComponent(data.cover)}`
                    : '';

                // æ¸²æŸ“ç›´æ’­é—´ä¿¡æ¯
                container.innerHTML = `
                <div class="room-card" style="width: 300px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                    <div class="cover-image" style="width: 100%; height: 180px; background-color: #f3f4f6; background-image: url('${coverUrl}'); background-size: cover; background-position: center;">
                        ${!coverUrl ? '<span style="color:#999; display: flex; align-items: center; justify-content: center; height: 100%;">æš‚æ— å°é¢</span>' : ''}
                    </div>
                    <div class="room-info" style="padding: 12px; font-family: Arial, sans-serif;">
                        <div class="room-title" style="font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 8px;" title="ç›´æ’­é—´æ ‡é¢˜">${data.title || 'æ— æ ‡é¢˜'}</div>
                        <div class="room-meta" style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">ä¸»æ’­: <span style="font-weight: bold; color: #2563eb;">${data.user_name || 'æœªçŸ¥ä¸»æ’­'}</span></div>
                        <div class="room-meta" style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">çŠ¶æ€: <span style="color:${data.state === 2 ? '#28a745' : '#6c757d'};">${getLiveState(data.state)}</span></div>
                        <div class="room-meta" style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">è§‚ä¼—äººæ•°: <span style="color: #007bff;">${data.current_people_num || 0}</span></div>
                        <div class="room-meta desc" style="font-size: 14px; color: #6b7280; margin-top: 8px;">ç®€ä»‹: ${data.description || 'æš‚æ— æè¿°'}</div>
                        ${data.state === 2 ? `<button onclick="enterLiveRoom(${data.room_id})" style="margin-top: 12px; padding: 8px 12px; background-color: #2563eb; color: #fff; border: none; border-radius: 4px; cursor: pointer;">è¿›å…¥ç›´æ’­é—´</button>` : ''}
                    </div>
                </div>
            `;
            } catch (error) {
                console.error('è·å–ç›´æ’­é—´ä¿¡æ¯å¤±è´¥:', error.message);
                document.getElementById('live-room').innerHTML = `<div style="padding:12px;color:#d9534f">${error.message}</div>`;
            }
        }

        // è¿›å…¥ç›´æ’­é—´
        function enterLiveRoom(roomId) {
            window.location.href = `/liveRoom?roomId=${roomId}`;
        }

        // è·å–ç›´æ’­é—´çŠ¶æ€æè¿°
        function getLiveState(state) {
            switch (state) {
                case 0:return 'ä¸»æ’­æœªåˆ›å»ºç›´æ’­é—´';
                case 1: return 'æœªå¼€æ’­';
                case 2: return 'å·²å¼€æ’­';
                default: return 'æœªçŸ¥çŠ¶æ€';
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        async function initPage() {
            await loadHeader('#header-container');
            await fetchUserInfo();
            bindAvatarUpload();

            // ä½ åŸæ¥çš„åˆå§‹åŒ–
            fetchUserArticles();
            fetchLiveRoom();
        }

        initPage();
    </script>
</body>
</html>
